<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seedance ä»»åŠ¡ç®¡ç†</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0e27;
    color: #e0e0e0;
    min-height: 100vh;
  }
  .header {
    background: linear-gradient(135deg, #1a1a3e 0%, #16213e 100%);
    padding: 20px 30px;
    border-bottom: 1px solid #1e3a5f;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header h1 {
    font-size: 20px;
    color: #a8d8ea;
  }
  .header .badge {
    background: #0f3460;
    color: #a8d8ea;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .panel {
    background: #16213e;
    border: 1px solid #1e3a5f;
    border-radius: 12px;
    padding: 20px;
  }
  .panel-title {
    font-size: 16px;
    color: #a8d8ea;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .panel-full { grid-column: 1 / -1; }

  /* Form */
  label {
    display: block;
    font-size: 12px;
    color: #8b8fa3;
    margin-bottom: 4px;
    margin-top: 12px;
  }
  label:first-child { margin-top: 0; }
  input[type="text"], textarea, select {
    width: 100%;
    padding: 8px 12px;
    background: #0d1b36;
    border: 1px solid #1e3a5f;
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 13px;
    font-family: inherit;
  }
  textarea { resize: vertical; min-height: 60px; }
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #3a7bd5;
  }
  select { cursor: pointer; }

  /* Checkbox */
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 10px 12px;
    background: #0d1b36;
    border: 1px solid #1e3a5f;
    border-radius: 6px;
  }
  .checkbox-row.warn {
    border-color: #e94560;
    background: rgba(233, 69, 96, 0.1);
  }
  .checkbox-row input[type="checkbox"] {
    width: 16px; height: 16px; cursor: pointer;
  }
  .checkbox-row .cb-label {
    font-size: 13px;
    cursor: pointer;
    flex: 1;
  }
  .checkbox-row .cb-hint {
    font-size: 10px;
    color: #e94560;
  }

  /* Quick insert row */
  .quick-insert-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
  }
  .qi-label {
    font-size: 11px;
    color: #8b8fa3;
    white-space: nowrap;
  }
  .qi-hint {
    font-size: 10px;
    color: #555;
    font-style: italic;
  }
  .qi-btn {
    padding: 3px 10px;
    font-size: 11px;
    border: 1px solid #1e3a5f;
    border-radius: 4px;
    background: #0d1b36;
    color: #a8d8ea;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .qi-btn:hover { border-color: #3a7bd5; color: #3a7bd5; background: rgba(58,123,213,0.08); }
  .qi-btn:active { transform: scale(0.95); }
  .qi-btn-custom { background: #16213e; }
  .qi-custom {
    width: 100px;
    padding: 3px 8px;
    font-size: 11px;
    background: #0d1b36;
    border: 1px solid #1e3a5f;
    border-radius: 4px;
    color: #e0e0e0;
  }
  .qi-custom:focus { border-color: #3a7bd5; outline: none; }

  /* Upload area */
  .upload-area {
    border: 2px dashed #1e3a5f;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 12px;
  }
  .upload-area:hover { border-color: #3a7bd5; background: rgba(58, 123, 213, 0.05); }
  .upload-area .icon { font-size: 28px; margin-bottom: 6px; }
  .upload-area .text { font-size: 13px; color: #8b8fa3; }
  .upload-file-input { display: none; }

  .file-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }
  .file-thumb {
    position: relative;
    width: 64px; height: 64px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #1e3a5f;
  }
  .file-thumb img {
    width: 100%; height: 100%;
    object-fit: cover;
  }
  .file-thumb .remove {
    position: absolute;
    top: 2px; right: 2px;
    width: 16px; height: 16px;
    background: rgba(233, 69, 96, 0.8);
    color: #fff;
    border: none;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Buttons */
  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }
  .btn-primary {
    background: linear-gradient(135deg, #3a7bd5, #6c5ce7);
    color: #fff;
    flex: 1;
  }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-secondary {
    background: #1e3a5f;
    color: #a8d8ea;
  }
  .btn-secondary:hover { background: #2a4a6f; }
  .btn-danger {
    background: #e94560;
    color: #fff;
  }
  .btn-danger:hover { background: #d63851; }
  .btn-sm {
    padding: 5px 12px;
    font-size: 12px;
    border-radius: 4px;
    border: 1px solid #1e3a5f;
    background: #16213e;
    color: #a8d8ea;
    cursor: pointer;
  }
  .btn-sm:hover { background: #1e3a5f; }
  .btn-sm.active { border-color: #3a7bd5; color: #3a7bd5; }

  /* Preset cards */
  .preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .preset-card {
    background: #0d1b36;
    border: 1px solid #1e3a5f;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .preset-card:hover { border-color: #3a7bd5; transform: translateY(-1px); }
  .preset-card .preset-name {
    font-size: 13px;
    font-weight: 600;
    color: #a8d8ea;
    margin-bottom: 6px;
  }
  .preset-card .preset-desc {
    font-size: 11px;
    color: #8b8fa3;
    margin-bottom: 6px;
    line-height: 1.4;
  }
  .preset-card .preset-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .preset-card .tag {
    font-size: 9px;
    padding: 2px 6px;
    background: #16213e;
    border-radius: 3px;
    color: #8b8fa3;
  }

  /* Task list */
  .task-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 10px;
  }
  .task-table th {
    text-align: left;
    padding: 8px;
    border-bottom: 1px solid #1e3a5f;
    color: #8b8fa3;
    font-weight: 500;
  }
  .task-table td {
    padding: 8px;
    border-bottom: 1px solid #0d1b36;
    color: #cbd5e1;
  }
  .task-table tr:hover td { background: rgba(58, 123, 213, 0.05); }
  .status-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }
  .status-pending { background: #1e3a5f; color: #a8d8ea; }
  .status-occupied { background: #7c3aed20; color: #a78bfa; }
  .status-acked { background: #065f4620; color: #34d399; }
  .status-running, .status-configuring { background: #92400e20; color: #fbbf24; }
  .status-generating { background: #f0ad4e20; color: #f0ad4e; }
  .status-uploading, .status-uploading_hd { background: #9b59b620; color: #9b59b6; }
  .status-upscaling { background: #e67e2220; color: #e67e22; }
  .status-completed { background: #064e3b20; color: #6ee7b7; }
  .status-failed { background: #7f1d1d20; color: #fca5a5; }

  /* Log */
  .log-area {
    background: #0d1b36;
    border: 1px solid #1e3a5f;
    border-radius: 6px;
    padding: 10px;
    font-family: 'Consolas', monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
    line-height: 1.6;
    color: #8b8fa3;
  }
  .log-area .log-success { color: #6ee7b7; }
  .log-area .log-error { color: #fca5a5; }

  /* SSE status */
  .sse-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }
  .sse-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #555;
  }
  .sse-dot.on { background: #4caf50; animation: pulse 2s infinite; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Model config row */
  .config-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* ===== ç§»åŠ¨ç«¯é€‚é… ===== */
  @media (max-width: 768px) {
    .header {
      padding: 12px 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .header h1 { font-size: 16px; }
    .sse-status { font-size: 11px; }

    .container {
      padding: 12px;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .panel { padding: 14px; border-radius: 10px; }
    .panel-full { grid-column: 1; }

    .config-row {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .preset-grid {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .preset-card { padding: 10px; }
    .preset-card .preset-desc { font-size: 10px; -webkit-line-clamp: 2; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }

    .upload-area { padding: 14px; }
    .upload-area .icon { font-size: 22px; }

    .btn { padding: 10px 14px; font-size: 13px; }
    .btn-row { flex-direction: column; }

    /* ä»»åŠ¡è¡¨æ ¼æ”¹ä¸ºå¡ç‰‡å¸ƒå±€ */
    .task-table thead { display: none; }
    .task-table, .task-table tbody, .task-table tr, .task-table td {
      display: block;
      width: 100%;
    }
    .task-table tr {
      background: #0d1b36;
      border: 1px solid #1e3a5f;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .task-table td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: none;
      font-size: 12px;
    }
    .task-table td::before {
      content: attr(data-label);
      font-size: 11px;
      color: #8b8fa3;
      font-weight: 500;
      margin-right: 8px;
      white-space: nowrap;
    }
  }

  @media (max-width: 420px) {
    .header h1 { font-size: 14px; }
    .container { padding: 8px; gap: 10px; }
    .panel { padding: 10px; }
    .preset-grid { grid-template-columns: 1fr; }
    .file-thumb { width: 52px; height: 52px; }
  }
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ“‹ Seedance ä»»åŠ¡ç®¡ç† (Mock Server)</h1>
  <div class="sse-status">
    <span class="sse-dot" id="sseDot"></span>
    <span id="sseStatusText">SSE: 0 å®¢æˆ·ç«¯</span>
    <span class="badge" id="taskCountBadge">0 ä»»åŠ¡</span>
    <a href="/files" style="color:#a8d8ea;text-decoration:none;font-size:12px;margin-left:8px;padding:4px 10px;background:#0d7377;border-radius:8px;">ğŸ“ æ–‡ä»¶é¢„è§ˆ</a>
  </div>
</div>

<div class="container">
  <!-- å·¦æ : åˆ›å»ºä»»åŠ¡ -->
  <div class="panel">
    <div class="panel-title">ğŸ“¤ æ¨é€æ–°ä»»åŠ¡</div>

    <label>æè¿°</label>
    <input type="text" id="taskDesc" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰">

    <label>æç¤ºè¯</label>
    <textarea id="taskPrompt" rows="3" placeholder="è¾“å…¥ç”Ÿæˆæç¤ºè¯ï¼Œæ”¯æŒ (@å›¾ç‰‡1) (@å›¾ç‰‡2) å¼•ç”¨..."></textarea>
    <div class="quick-insert-row" id="quickInsertRow">
      <span class="qi-label">å¿«æ·æ’å…¥:</span>
      <span class="qi-hint" id="qiHint">è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾ç‰‡</span>
      <span id="qiButtons"></span>
      <input class="qi-custom" id="qiCustom" type="text" placeholder="è‡ªå®šä¹‰æ–‡ä»¶å" maxlength="60">
      <button class="qi-btn qi-btn-custom" id="qiCustomBtn">æ’å…¥ (@...)</button>
    </div>

    <div class="config-row">
      <div>
        <label>æ¨¡å‹</label>
        <select id="cfgModel">
          <option value="Seedance 2.0 Fast" selected>Seedance 2.0 Fast</option>
          <option value="Seedance 2.0">Seedance 2.0</option>
        </select>
      </div>
      <div>
        <label>å‚è€ƒæ¨¡å¼</label>
        <select id="cfgRefMode">
          <option value="å…¨èƒ½å‚è€ƒ" selected>å…¨èƒ½å‚è€ƒ</option>
          <option value="é¦–å°¾å¸§">é¦–å°¾å¸§</option>
          <option value="ä¸»ä½“å‚è€ƒ">ä¸»ä½“å‚è€ƒ</option>
        </select>
      </div>
    </div>
    <div class="config-row">
      <div>
        <label>ç”»é¢æ¯”ä¾‹</label>
        <select id="cfgRatio">
          <option value="16:9" selected>16:9</option>
          <option value="9:16">9:16</option>
          <option value="1:1">1:1</option>
          <option value="4:3">4:3</option>
          <option value="3:4">3:4</option>
          <option value="21:9">21:9</option>
          <option value="9:21">9:21</option>
        </select>
      </div>
      <div>
        <label>è§†é¢‘æ—¶é•¿</label>
        <select id="cfgDuration">
          <option value="4s" selected>4s</option>
          <option value="5s">5s</option>
          <option value="6s">6s</option>
          <option value="7s">7s</option>
          <option value="8s">8s</option>
          <option value="9s">9s</option>
          <option value="10s">10s</option>
        </select>
      </div>
    </div>

    <label>å‚è€ƒå›¾ç‰‡</label>
    <div class="upload-area" id="uploadArea">
      <div class="icon">ğŸ“</div>
      <div class="text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒå›¾ç‰‡</div>
    </div>
    <input type="file" class="upload-file-input" id="fileInput" multiple accept="image/jpeg,image/png,image/webp">
    <div class="file-preview" id="filePreview"></div>

    <div class="checkbox-row" id="realSubmitRow">
      <input type="checkbox" id="realSubmit">
      <label class="cb-label" for="realSubmit">çœŸå®æäº¤åˆ° Seedance 2.0 ç”Ÿæˆ</label>
      <span class="cb-hint">é»˜è®¤æ¨¡æ‹Ÿ</span>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="btnPush">ğŸ“¤ æ¨é€ä»»åŠ¡</button>
    </div>
  </div>

  <!-- å³æ : é¢„åˆ¶æ¡ˆä¾‹ -->
  <div class="panel">
    <div class="panel-title">âš¡ å¿«æ·é¢„åˆ¶æ¡ˆä¾‹</div>
    <p style="font-size: 11px; color: #8b8fa3; margin-bottom: 10px;">ç‚¹å‡»å¡ç‰‡ä¸€é”®å¡«å……ï¼Œæˆ–ç›´æ¥æ¨é€</p>
    <div class="preset-grid" id="presetGrid"></div>

    <div style="margin-top: 20px; border-top: 1px solid #1e3a5f; padding-top: 15px;">
      <div class="panel-title" style="margin-bottom: 10px;">ğŸ“¡ SSE å®¢æˆ·ç«¯</div>
      <div id="sseClientList" style="font-size: 12px; color: #8b8fa3;">æš‚æ— è¿æ¥</div>
    </div>

    <div style="margin-top: 15px;">
      <div class="panel-title" style="margin-bottom: 10px;">ğŸ“ æ“ä½œæ—¥å¿—</div>
      <div class="log-area" id="logArea"></div>
    </div>
  </div>

  <!-- åº•éƒ¨: ä»»åŠ¡åˆ—è¡¨ -->
  <div class="panel panel-full">
    <div class="panel-title" style="justify-content: space-between;">
      <span>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</span>
      <button class="btn-sm" id="btnRefreshTasks">ğŸ”„ åˆ·æ–°</button>
    </div>
    <table class="task-table">
      <thead>
        <tr>
          <th>ä»»åŠ¡ç¼–å·</th>
          <th>æè¿°</th>
          <th>æç¤ºè¯</th>
          <th>å›¾ç‰‡</th>
          <th>çŠ¶æ€</th>
          <th>çœŸå®æäº¤</th>
          <th>å ç”¨è€…</th>
          <th>åˆ›å»ºæ—¶é—´</th>
        </tr>
      </thead>
      <tbody id="taskTableBody">
        <tr><td colspan="8" style="text-align:center;color:#555;">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const API = window.location.origin;

// ============================================================
// é¢„åˆ¶æ¡ˆä¾‹
// ============================================================
const PRESETS = [
  {
    name: 'ğŸ’ƒ å¥³å­©è·³èˆ',
    description: 'å¥³å­©åœ¨èˆå°ä¸Šä¼˜é›…è·³èˆï¼Œå¸¦å‚è€ƒå›¾ï¼Œ16:9 æ¨ªå±',
    prompt: 'ä¸€ä¸ªç©¿ç€çº¢è‰²è¿è¡£è£™çš„å¥³å­© (@å›¾ç‰‡1) åœ¨ç¯å…‰ç’€ç’¨çš„èˆå°ä¸­å¤®ä¼˜é›…åœ°æ—‹è½¬è·³èˆï¼Œè£™æ‘†é£æ‰¬',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '16:9', duration: '4s' },
    tags: ['portrait', 'dance', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[200, 100, 100]],
  },
  {
    name: 'ğŸ”ï¸ å±±è„‰æ—¥å‡º',
    description: 'å£®ä¸½å±±è„‰å»¶æ—¶æ‘„å½±ï¼Œå¸¦å‚è€ƒå›¾ï¼Œäº‘æµ·ç¿»æ¶Œ',
    prompt: 'å£®ä¸½çš„å±±è„‰æ—¥å‡ºå»¶æ—¶æ‘„å½± (@å›¾ç‰‡1) é‡‘è‰²é˜³å…‰æ´’æ»¡å±±è°· äº‘æµ·ç¿»æ¶Œå…‰å½±å˜å¹»',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '16:9', duration: '4s' },
    tags: ['landscape', 'nature', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[80, 130, 200]],
  },
  {
    name: 'ğŸ“¦ äº§å“å±•ç¤º',
    description: 'äº§å“360åº¦æ—‹è½¬å±•ç¤ºï¼Œå¸¦å‚è€ƒå›¾ï¼Œ1:1æ­£æ–¹å½¢',
    prompt: 'ç²¾è‡´çš„äº§å“åœ¨çº¯ç™½èƒŒæ™¯ä¸Šç¼“æ…¢360åº¦æ—‹è½¬å±•ç¤º (@å›¾ç‰‡1) å…‰å½±æŸ”å’Œç»†èŠ‚æ¸…æ™°',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '1:1', duration: '4s' },
    tags: ['product', 'commercial', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[240, 240, 240]],
  },
  {
    name: 'ğŸŒŠ æµ·æµªæ²™æ»©',
    description: 'æµ·æµªæ‹æ‰“æ²™æ»©ï¼Œå¸¦å‚è€ƒå›¾ï¼Œç«–å±è§†é¢‘',
    prompt: 'è”šè“æµ·æµªè½»æŸ”åœ°æ‹æ‰“é‡‘è‰²æ²™æ»© (@å›¾ç‰‡1) æ³¡æ²«é€€å»ç•™ä¸‹æ°´æ¸ é˜³å…‰åœ¨æ°´é¢ä¸Šé—ªçƒ',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '9:16', duration: '4s' },
    tags: ['nature', 'ocean', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[40, 120, 200]],
  },
  {
    name: 'ğŸ± çŒ«å’ªç‰¹å†™',
    description: 'å¯çˆ±çŒ«å’ªè½¬å¤´çœ‹é•œå¤´ï¼Œå¸¦å‚è€ƒå›¾',
    prompt: 'ä¸€åªæ¯›èŒ¸èŒ¸çš„æ©˜çŒ« (@å›¾ç‰‡1) æ…¢æ…¢è½¬å¤´çœ‹å‘é•œå¤´ çœ¨äº†çœ¨å¤§çœ¼ç› èƒŒæ™¯è™šåŒ–',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '1:1', duration: '4s' },
    tags: ['animal', 'cute', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[220, 160, 60]],
  },
  {
    name: 'ğŸ™ï¸ åŸå¸‚å¤œæ™¯',
    description: 'åŸå¸‚éœ“è™¹ç¯å¤œæ™¯å»¶æ—¶ï¼Œå¸¦å‚è€ƒå›¾',
    prompt: 'ç¹åéƒ½å¸‚å¤œæ™¯å»¶æ—¶æ‘„å½± (@å›¾ç‰‡1) éœ“è™¹ç¯é—ªçƒ è½¦æµå½¢æˆå…‰è½¨ é«˜æ¥¼å¤§å¦ç¯ç«è¾‰ç…Œ',
    modelConfig: { model: 'Seedance 2.0 Fast', referenceMode: 'å…¨èƒ½å‚è€ƒ', aspectRatio: '21:9', duration: '4s' },
    tags: ['city', 'night', 'å¸¦å›¾'],
    useTestImage: true,
    testImageColors: [[30, 30, 80]],
  },
];

// ============================================================
// çŠ¶æ€
// ============================================================
let uploadedFiles = []; // { name, base64, type }

// æ¸…ç†æ–‡ä»¶åä¸­çš„æ‹¬å·ï¼Œé¿å…å¹²æ‰° (@xxx) mention è¯­æ³•
function sanitizeFileName(name) {
  return name.replace(/[()\uff08\uff09\[\]\u3010\u3011{}\uff5b\uff5d]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
}

// ============================================================
// DOM
// ============================================================
const taskDesc = document.getElementById('taskDesc');
const taskPrompt = document.getElementById('taskPrompt');
const cfgModel = document.getElementById('cfgModel');
const cfgRefMode = document.getElementById('cfgRefMode');
const cfgRatio = document.getElementById('cfgRatio');
const cfgDuration = document.getElementById('cfgDuration');
const realSubmitCb = document.getElementById('realSubmit');
const realSubmitRow = document.getElementById('realSubmitRow');
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const btnPush = document.getElementById('btnPush');
const presetGrid = document.getElementById('presetGrid');
const logArea = document.getElementById('logArea');
const taskTableBody = document.getElementById('taskTableBody');
const btnRefreshTasks = document.getElementById('btnRefreshTasks');
const sseDot = document.getElementById('sseDot');
const sseStatusText = document.getElementById('sseStatusText');
const taskCountBadge = document.getElementById('taskCountBadge');
const sseClientList = document.getElementById('sseClientList');

// ============================================================
// çœŸå®æäº¤è­¦å‘Šæ ·å¼
// ============================================================
// ============================================================
// å¿«æ·æ’å…¥
// ============================================================
const qiCustom = document.getElementById('qiCustom');
const qiCustomBtn = document.getElementById('qiCustomBtn');
const qiButtons = document.getElementById('qiButtons');
const qiHint = document.getElementById('qiHint');

function insertAtCursor(text) {
  taskPrompt.focus();
  const start = taskPrompt.selectionStart;
  const end = taskPrompt.selectionEnd;
  const before = taskPrompt.value.substring(0, start);
  const after = taskPrompt.value.substring(end);
  const needSpaceBefore = before.length > 0 && !before.endsWith(' ') && !before.endsWith('\n');
  const needSpaceAfter = after.length > 0 && !after.startsWith(' ') && !after.startsWith('\n');
  const insert = (needSpaceBefore ? ' ' : '') + text + (needSpaceAfter ? ' ' : '');
  taskPrompt.value = before + insert + after;
  const newPos = start + insert.length;
  taskPrompt.setSelectionRange(newPos, newPos);
  taskPrompt.focus();
}

function updateQuickInsert() {
  qiButtons.innerHTML = '';
  if (uploadedFiles.length === 0) {
    qiHint.style.display = '';
    return;
  }
  qiHint.style.display = 'none';
  uploadedFiles.forEach((f) => {
    const btn = document.createElement('button');
    btn.className = 'qi-btn';
    const tag = `(@${f.fileName})`;
    btn.textContent = tag;
    btn.title = `æ’å…¥ ${tag}`;
    btn.dataset.insert = tag;
    qiButtons.appendChild(btn);
  });
}

document.getElementById('quickInsertRow').addEventListener('click', (e) => {
  const btn = e.target.closest('.qi-btn');
  if (!btn) return;
  if (btn.id === 'qiCustomBtn') {
    const name = qiCustom.value.trim();
    if (!name) { qiCustom.focus(); return; }
    insertAtCursor(`(@${name})`);
    qiCustom.value = '';
  } else if (btn.dataset.insert) {
    insertAtCursor(btn.dataset.insert);
  }
});

qiCustom.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    qiCustomBtn.click();
  }
});

// ============================================================
// çœŸå®æäº¤è­¦å‘Šæ ·å¼
// ============================================================
realSubmitCb.addEventListener('change', () => {
  if (realSubmitCb.checked) {
    realSubmitRow.classList.add('warn');
    realSubmitRow.querySelector('.cb-hint').textContent = 'âš ï¸ å°†çœŸå®æäº¤!';
  } else {
    realSubmitRow.classList.remove('warn');
    realSubmitRow.querySelector('.cb-hint').textContent = 'é»˜è®¤æ¨¡æ‹Ÿ';
  }
});

// ============================================================
// æ–‡ä»¶ä¸Šä¼ 
// ============================================================
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#3a7bd5'; });
uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = '#1e3a5f'; });
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.style.borderColor = '#1e3a5f';
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', (e) => {
  handleFiles(e.target.files);
  fileInput.value = '';
});

function handleFiles(files) {
  for (const file of files) {
    if (!file.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = (e) => {
      uploadedFiles.push({
        fileName: sanitizeFileName(file.name),
        base64: e.target.result,
        fileType: file.type,
      });
      renderFilePreview();
    };
    reader.readAsDataURL(file);
  }
}

function renderFilePreview() {
  filePreview.innerHTML = '';
  uploadedFiles.forEach((f, i) => {
    const thumb = document.createElement('div');
    thumb.className = 'file-thumb';
    thumb.innerHTML = `
      <img src="${f.base64}" alt="${f.fileName}">
      <button class="remove" data-idx="${i}" title="ç§»é™¤">&times;</button>
    `;
    filePreview.appendChild(thumb);
  });
  filePreview.querySelectorAll('.remove').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      uploadedFiles.splice(parseInt(btn.dataset.idx), 1);
      renderFilePreview();
    });
  });
  updateQuickInsert();
}

// ============================================================
// é¢„åˆ¶æ¡ˆä¾‹æ¸²æŸ“
// ============================================================
function renderPresets() {
  presetGrid.innerHTML = '';
  PRESETS.forEach((preset, idx) => {
    const card = document.createElement('div');
    card.className = 'preset-card';
    card.innerHTML = `
      <div class="preset-name">${preset.name}</div>
      <div class="preset-desc">${preset.description}</div>
      <div class="preset-tags">
        ${preset.tags.map(t => `<span class="tag">${t}</span>`).join('')}
        <span class="tag">${preset.modelConfig.aspectRatio}</span>
        <span class="tag">${preset.modelConfig.duration}</span>
      </div>
      <div style="margin-top:8px;display:flex;gap:5px;">
        <button class="btn-sm" data-action="fill" data-idx="${idx}">ğŸ“ å¡«å……</button>
        <button class="btn-sm" data-action="push" data-idx="${idx}">ğŸ“¤ æ¨é€</button>
      </div>
    `;
    presetGrid.appendChild(card);
  });

  presetGrid.querySelectorAll('[data-action="fill"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      fillFromPreset(parseInt(btn.dataset.idx));
    });
  });

  presetGrid.querySelectorAll('[data-action="push"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      pushPreset(parseInt(btn.dataset.idx));
    });
  });
}

function fillFromPreset(idx) {
  const p = PRESETS[idx];
  taskDesc.value = p.description;
  taskPrompt.value = p.prompt;
  cfgModel.value = p.modelConfig.model;
  cfgRefMode.value = p.modelConfig.referenceMode;
  cfgRatio.value = p.modelConfig.aspectRatio;
  cfgDuration.value = p.modelConfig.duration;
  // ç”Ÿæˆæµ‹è¯•å›¾ç‰‡å¹¶å¡«å……åˆ°ä¸Šä¼ åŒº
  uploadedFiles = [];
  if (p.useTestImage && p.testImageColors) {
    p.testImageColors.forEach((color, i) => {
      const base64 = generateTestImage(color[0], color[1], color[2]);
      uploadedFiles.push({
        fileName: `å›¾ç‰‡${i + 1}`,
        base64,
        fileType: 'image/png',
      });
    });
  }
  renderFilePreview();
  addLog(`ğŸ“ å·²å¡«å……é¢„åˆ¶æ¡ˆä¾‹: ${p.name} (${uploadedFiles.length} å¼ å‚è€ƒå›¾)`);
}

function generateTestImage(r, g, b, size = 512) {
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = `rgb(${r},${g},${b})`;
  ctx.fillRect(0, 0, size, size);
  // ç”»ä¸ªåå­—æ ‡è®°è¡¨ç¤ºæµ‹è¯•å›¾
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(size / 2, 0);
  ctx.lineTo(size / 2, size);
  ctx.moveTo(0, size / 2);
  ctx.lineTo(size, size / 2);
  ctx.stroke();
  // æ ‡æ³¨é¢œè‰²å€¼
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.font = '24px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(`TEST (${r},${g},${b})`, size / 2, size / 2 + 8);
  return canvas.toDataURL('image/png');
}

async function pushPreset(idx) {
  const p = PRESETS[idx];

  // æ ¹æ® testImageColors ç”Ÿæˆæµ‹è¯•å›¾ç‰‡
  const refFiles = [];
  if (p.useTestImage && p.testImageColors) {
    p.testImageColors.forEach((color, i) => {
      const base64 = generateTestImage(color[0], color[1], color[2]);
      refFiles.push({
        fileName: `å›¾ç‰‡${i + 1}`,
        base64,
        fileType: 'image/png',
      });
    });
  }

  const task = {
    description: p.description,
    prompt: p.prompt,
    tags: p.tags,
    modelConfig: p.modelConfig,
    referenceFiles: refFiles,
    realSubmit: realSubmitCb.checked,
  };

  try {
    const resp = await fetch(`${API}/api/tasks/push`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(task),
    });
    const data = await resp.json();
    if (data.success) {
      addLog(`âœ… é¢„åˆ¶æ¡ˆä¾‹ "${p.name}" å·²æ¨é€: ${data.taskCodes.join(', ')}`, 'success');
      refreshTaskList();
    } else {
      addLog(`âŒ æ¨é€å¤±è´¥: ${data.error}`, 'error');
    }
  } catch (err) {
    addLog(`âŒ æ¨é€å¼‚å¸¸: ${err.message}`, 'error');
  }
}

// ============================================================
// æ¨é€ä»»åŠ¡
// ============================================================
btnPush.addEventListener('click', async () => {
  const prompt = taskPrompt.value.trim();
  if (!prompt && uploadedFiles.length === 0) {
    addLog('âš ï¸ è¯·è¾“å…¥æç¤ºè¯æˆ–ä¸Šä¼ å‚è€ƒå›¾', 'error');
    return;
  }

  btnPush.disabled = true;
  btnPush.textContent = 'â³ æ¨é€ä¸­...';

  const task = {
    description: taskDesc.value.trim(),
    prompt,
    modelConfig: {
      model: cfgModel.value,
      referenceMode: cfgRefMode.value,
      aspectRatio: cfgRatio.value,
      duration: cfgDuration.value,
    },
    referenceFiles: uploadedFiles.map(f => ({
      fileName: f.fileName,
      base64: f.base64,
      fileType: f.fileType,
    })),
    realSubmit: realSubmitCb.checked,
  };

  try {
    const resp = await fetch(`${API}/api/tasks/push`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(task),
    });
    const data = await resp.json();
    if (data.success) {
      addLog(`âœ… ä»»åŠ¡å·²æ¨é€: ${data.taskCodes.join(', ')} (é€šçŸ¥ ${data.notified} ä¸ªå®¢æˆ·ç«¯)`, 'success');
      refreshTaskList();
      // æ¸…ç©ºè¡¨å•
      taskDesc.value = '';
      taskPrompt.value = '';
      uploadedFiles = [];
      renderFilePreview();
    } else {
      addLog(`âŒ æ¨é€å¤±è´¥: ${data.error}`, 'error');
    }
  } catch (err) {
    addLog(`âŒ æ¨é€å¼‚å¸¸: ${err.message}`, 'error');
  }

  btnPush.disabled = false;
  btnPush.textContent = 'ğŸ“¤ æ¨é€ä»»åŠ¡';
});

// ============================================================
// ä»»åŠ¡åˆ—è¡¨
// ============================================================
const STATUS_LABELS = {
  pending: 'å¾…å¤„ç†',
  occupied: 'å·²å ç”¨',
  acked: 'å·²ç¡®è®¤',
  configuring: 'âš™ï¸ é…ç½®ä¸­',
  running: 'æ‰§è¡Œä¸­',
  generating: 'ğŸ¬ ç”Ÿæˆä¸­',
  uploading: 'ğŸ“¤ ä¸Šä¼ æ ‡æ¸…',
  upscaling: 'ğŸ”º æå‡ä¸­',
  uploading_hd: 'ğŸ“¤ ä¸Šä¼ é«˜æ¸…',
  completed: 'âœ… å®Œæˆ',
  failed: 'âŒ å¤±è´¥',
};

async function refreshTaskList() {
  try {
    const resp = await fetch(`${API}/api/tasks`);
    const data = await resp.json();
    taskCountBadge.textContent = `${data.total} ä»»åŠ¡`;

    if (data.tasks.length === 0) {
      taskTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#555;">æš‚æ— ä»»åŠ¡</td></tr>';
      return;
    }

    taskTableBody.innerHTML = data.tasks.map(t => `
      <tr>
        <td data-label="ç¼–å·"><code style="color:#a8d8ea;">${t.taskCode}</code></td>
        <td data-label="æè¿°">${escapeHtml(t.description || '-')}</td>
        <td data-label="æç¤ºè¯" title="${escapeHtml(t.prompt)}">${escapeHtml((t.prompt || '-').substring(0, 30))}${t.prompt && t.prompt.length > 30 ? '...' : ''}</td>
        <td data-label="å›¾ç‰‡">${t.referenceFileCount || 0} å¼ </td>
        <td data-label="çŠ¶æ€"><span class="status-badge status-${t.status}">${STATUS_LABELS[t.status] || t.status}</span></td>
        <td data-label="çœŸå®æäº¤">${t.realSubmit ? '<span style="color:#e94560;">âœ… æ˜¯</span>' : '<span style="color:#555;">å¦</span>'}</td>
        <td data-label="å ç”¨è€…" style="font-size:10px;color:#555;">${t.occupiedBy ? t.occupiedBy.substring(0, 16) : '-'}</td>
        <td data-label="æ—¶é—´" style="font-size:10px;">${new Date(t.createdAt).toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>
      </tr>
    `).join('');
  } catch (err) {
    addLog(`âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${err.message}`, 'error');
  }
}

btnRefreshTasks.addEventListener('click', refreshTaskList);

// ============================================================
// SSE çŠ¶æ€ç›‘å¬
// ============================================================
function updateSSEStatus() {
  fetch(`${API}/`)
    .then(r => r.json())
    .then(data => {
      const count = data.sseClients || 0;
      sseDot.className = count > 0 ? 'sse-dot on' : 'sse-dot';
      sseStatusText.textContent = `SSE: ${count} å®¢æˆ·ç«¯`;
      sseClientList.textContent = count > 0 ? `${count} ä¸ªæ‰©å±•å®¢æˆ·ç«¯åœ¨çº¿` : 'æš‚æ— è¿æ¥';
    })
    .catch(() => {});
}

// ============================================================
// æ—¥å¿—
// ============================================================
function addLog(msg, type) {
  const time = new Date().toLocaleTimeString('zh-CN');
  const cls = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : '';
  logArea.innerHTML += `<div class="${cls}">[${time}] ${escapeHtml(msg)}</div>`;
  logArea.scrollTop = logArea.scrollHeight;
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ============================================================
// åˆå§‹åŒ–
// ============================================================
renderPresets();
refreshTaskList();
updateSSEStatus();
setInterval(updateSSEStatus, 5000);
setInterval(refreshTaskList, 10000);
addLog('ğŸš€ ç®¡ç†é¡µé¢å·²åŠ è½½');
</script>
</body>
</html>
